!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("babylonjs-ktx2decoder",[],t):"object"==typeof exports?exports["babylonjs-ktx2decoder"]=t():e.KTX2DECODER=t()}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var t={};e.d(t,{default:()=>G});var r,a,s,n,o={};e.r(o),e.d(o,{DataReader:()=>i,KTX2Decoder:()=>E,KTX2FileReader:()=>d,LiteTranscoder:()=>h,LiteTranscoder_UASTC_ASTC:()=>m,LiteTranscoder_UASTC_BC7:()=>u,LiteTranscoder_UASTC_RGBA_SRGB:()=>p,LiteTranscoder_UASTC_RGBA_UNORM:()=>f,MSCTranscoder:()=>g,SupercompressionScheme:()=>n,Transcoder:()=>l,TranscoderManager:()=>_,WASMMemoryManager:()=>c,ZSTDDecoder:()=>M}),function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(r||(r={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(a||(a={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(s||(s={}));class i{get byteOffset(){return this._dataByteOffset}constructor(e,t,r){e.buffer?this._dataView=new DataView(e.buffer,e.byteOffset+(t??0),r??e.byteLength):this._dataView=new DataView(e,t??0,r??e.byteLength),this._dataByteOffset=0}readUint8(){const e=this._dataView.getUint8(this._dataByteOffset);return this._dataByteOffset+=1,e}readInt8(){const e=this._dataView.getInt8(this._dataByteOffset);return this._dataByteOffset+=1,e}readUint16(){const e=this._dataView.getUint16(this._dataByteOffset,!0);return this._dataByteOffset+=2,e}readInt16(){const e=this._dataView.getInt16(this._dataByteOffset,!0);return this._dataByteOffset+=2,e}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,e}readInt32(){const e=this._dataView.getInt32(this._dataByteOffset,!0);return this._dataByteOffset+=4,e}readUint64(){const e=this._dataView.getUint32(this._dataByteOffset,!0)+2**32*this._dataView.getUint32(this._dataByteOffset+4,!0);return this._dataByteOffset+=8,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,t}skipBytes(e){return this._dataByteOffset+=e,this}}!function(e){e[e.None=0]="None",e[e.BasisLZ=1]="BasisLZ",e[e.ZStandard=2]="ZStandard",e[e.ZLib=3]="ZLib"}(n||(n={}));class d{constructor(e){this._data=e}get data(){return this._data}get header(){return this._header}get levels(){return this._levels}get dfdBlock(){return this._dfdBlock}get supercompressionGlobalData(){return this._supercompressionGlobalData}isValid(){return d.IsValid(this._data)}parse(){let e=12;const t=new i(this._data,e,68),r=this._header={vkFormat:t.readUint32(),typeSize:t.readUint32(),pixelWidth:t.readUint32(),pixelHeight:t.readUint32(),pixelDepth:t.readUint32(),layerCount:t.readUint32(),faceCount:t.readUint32(),levelCount:t.readUint32(),supercompressionScheme:t.readUint32(),dfdByteOffset:t.readUint32(),dfdByteLength:t.readUint32(),kvdByteOffset:t.readUint32(),kvdByteLength:t.readUint32(),sgdByteOffset:t.readUint64(),sgdByteLength:t.readUint64()};if(r.pixelDepth>0)throw new Error("Failed to parse KTX2 file - Only 2D textures are currently supported.");if(r.layerCount>1)throw new Error("Failed to parse KTX2 file - Array textures are not currently supported.");if(r.faceCount>1)throw new Error("Failed to parse KTX2 file - Cube textures are not currently supported.");e+=t.byteOffset;let a=Math.max(1,r.levelCount);const s=new i(this._data,e,3*a*8),n=this._levels=[];for(;a--;)n.push({byteOffset:s.readUint64(),byteLength:s.readUint64(),uncompressedByteLength:s.readUint64()});e+=s.byteOffset;const o=new i(this._data,r.dfdByteOffset,r.dfdByteLength),d=this._dfdBlock={vendorId:o.skipBytes(4).readUint16(),descriptorType:o.readUint16(),versionNumber:o.readUint16(),descriptorBlockSize:o.readUint16(),colorModel:o.readUint8(),colorPrimaries:o.readUint8(),transferFunction:o.readUint8(),flags:o.readUint8(),texelBlockDimension:{x:o.readUint8()+1,y:o.readUint8()+1,z:o.readUint8()+1,w:o.readUint8()+1},bytesPlane:[o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8()],numSamples:0,samples:new Array};d.numSamples=(d.descriptorBlockSize-24)/16;for(let e=0;e<d.numSamples;e++){const e={bitOffset:o.readUint16(),bitLength:o.readUint8()+1,channelType:o.readUint8(),channelFlags:0,samplePosition:[o.readUint8(),o.readUint8(),o.readUint8(),o.readUint8()],sampleLower:o.readUint32(),sampleUpper:o.readUint32()};e.channelFlags=(240&e.channelType)>>4,e.channelType=15&e.channelType,d.samples.push(e)}const c=this._supercompressionGlobalData={};if(r.sgdByteLength>0){const e=new i(this._data,r.sgdByteOffset,r.sgdByteLength);c.endpointCount=e.readUint16(),c.selectorCount=e.readUint16(),c.endpointsByteLength=e.readUint32(),c.selectorsByteLength=e.readUint32(),c.tablesByteLength=e.readUint32(),c.extendedByteLength=e.readUint32(),c.imageDescs=[];const t=this._getImageCount();for(let r=0;r<t;r++)c.imageDescs.push({imageFlags:e.readUint32(),rgbSliceByteOffset:e.readUint32(),rgbSliceByteLength:e.readUint32(),alphaSliceByteOffset:e.readUint32(),alphaSliceByteLength:e.readUint32()});const a=r.sgdByteOffset+e.byteOffset,s=a+c.endpointsByteLength,n=s+c.selectorsByteLength,o=n+c.tablesByteLength;c.endpointsData=new Uint8Array(this._data.buffer,this._data.byteOffset+a,c.endpointsByteLength),c.selectorsData=new Uint8Array(this._data.buffer,this._data.byteOffset+s,c.selectorsByteLength),c.tablesData=new Uint8Array(this._data.buffer,this._data.byteOffset+n,c.tablesByteLength),c.extendedData=new Uint8Array(this._data.buffer,this._data.byteOffset+o,c.extendedByteLength)}}_getImageCount(){let e=Math.max(this._header.pixelDepth,1);for(let t=1;t<this._header.levelCount;t++)e+=Math.max(this._header.pixelDepth>>t,1);return Math.max(this._header.layerCount,1)*this._header.faceCount*e}get textureFormat(){return 166===this._dfdBlock.colorModel?r.UASTC4x4:r.ETC1S}get hasAlpha(){switch(this.textureFormat){case r.ETC1S:return 2===this._dfdBlock.numSamples&&(15===this._dfdBlock.samples[0].channelType||15===this._dfdBlock.samples[1].channelType);case r.UASTC4x4:return 3===this._dfdBlock.samples[0].channelType}return!1}get needZSTDDecoder(){return this._header.supercompressionScheme===n.ZStandard}get isInGammaSpace(){return 2===this._dfdBlock.transferFunction}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}class c{static LoadWASM(e){if(this.LoadBinariesFromCurrentThread)return new Promise(((t,r)=>{fetch(e).then((t=>{if(t.ok)return t.arrayBuffer();throw new Error(`Could not fetch the wasm component from "${e}": ${t.status} - ${t.statusText}`)})).then((e=>t(e))).catch((e=>{r(e)}))}));const t=this._RequestId++;return new Promise((r=>{const a=e=>{"wasmLoaded"===e.data.action&&e.data.id===t&&(self.removeEventListener("message",a),r(e.data.wasmBinary))};self.addEventListener("message",a),postMessage({action:"loadWASM",path:e,id:t})}))}constructor(e=c.InitialMemoryPages){this._numPages=e,this._memory=new WebAssembly.Memory({initial:this._numPages}),this._memoryViewByteLength=this._numPages<<16,this._memoryViewOffset=0,this._memoryView=new Uint8Array(this._memory.buffer,this._memoryViewOffset,this._memoryViewByteLength)}get wasmMemory(){return this._memory}getMemoryView(e,t=0,r){return r=r??e<<16,this._numPages<e?(this._memory.grow(e-this._numPages),this._numPages=e,this._memoryView=new Uint8Array(this._memory.buffer,t,r),this._memoryViewByteLength=r,this._memoryViewOffset=t):(this._memoryView=new Uint8Array(this._memory.buffer,t,r),this._memoryViewByteLength=r,this._memoryViewOffset=t),this._memoryView}}c.LoadBinariesFromCurrentThread=!0,c.InitialMemoryPages=16,c._RequestId=0;class _{static RegisterTranscoder(e){_._Transcoders.push(e)}findTranscoder(e,t,s,n){let o=null;const i=r[e]+"_"+a[t];for(let r=0;r<_._Transcoders.length;++r)if(_._Transcoders[r].CanTranscode(e,t,s)&&(!n||n.indexOf(_._Transcoders[r].Name)<0)){o=this._getExistingTranscoder(i,_._Transcoders[r].Name),o||(o=new _._Transcoders[r],o.initialize(),o.needMemoryManager()&&(this._wasmMemoryManager||(this._wasmMemoryManager=new c),o.setMemoryManager(this._wasmMemoryManager)),_._TranscoderInstances[i]||(_._TranscoderInstances[i]=[]),_._TranscoderInstances[i].push(o));break}return o}_getExistingTranscoder(e,t){const r=_._TranscoderInstances[e];if(r)for(let e=0;e<r.length;++e){const a=r[e];if(t===a.getName())return a}return null}}_._Transcoders=[],_._TranscoderInstances={};class l{static CanTranscode(e,t,r){return!1}getName(){return l.Name}initialize(){}needMemoryManager(){return!1}setMemoryManager(e){}transcode(e,t,r,a,s,n,o,i,d){return Promise.resolve(null)}}l.Name="Transcoder";class h extends l{_loadModule(){return this._modulePromise||(this._modulePromise=c.LoadWASM(this._modulePath).then((e=>new Promise((t=>{WebAssembly.instantiate(e,{env:{memory:this._memoryManager.wasmMemory}}).then((e=>{t({module:e.instance.exports})}))}))))),this._modulePromise}get memoryManager(){return this._memoryManager}setModulePath(e){this._modulePath=e}initialize(){this._transcodeInPlace=!0}needMemoryManager(){return!0}setMemoryManager(e){this._memoryManager=e}transcode(e,t,r,a,s,n,o,i,d){return this._loadModule().then((e=>{const t=e.module,[r,o,i]=this._prepareTranscoding(a,s,n,d);return 0===t.transcode(i)?this._transcodeInPlace?r.slice():o.slice():null}))}_prepareTranscoding(e,t,r,a,s){const n=(e+3>>2)*(t+3>>2);void 0!==s&&(r=e*(t+3>>2)*4*s);const o=1+(16*n+65535+(this._transcodeInPlace?0:r)>>16),i=this.memoryManager.getMemoryView(o,65536,16*n),d=this._transcodeInPlace?null:new Uint8Array(this._memoryManager.wasmMemory.buffer,65536+16*n,void 0!==s?e*t*s:r);return i.set(a),[i,d,n]}}class m extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.ASTC_4X4_RGBA}getName(){return m.Name}initialize(){super.initialize(),this.setModulePath(m.WasmModuleURL)}}m.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/uastc_astc.wasm",m.Name="UniversalTranscoder_UASTC_ASTC";class u extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.BC7_RGBA}getName(){return u.Name}initialize(){super.initialize(),this.setModulePath(u.WasmModuleURL)}}u.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/uastc_bc7.wasm",u.Name="UniversalTranscoder_UASTC_BC7";class f extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.RGBA32&&!s}getName(){return f.Name}initialize(){super.initialize(),this._transcodeInPlace=!1,this.setModulePath(f.WasmModuleURL)}transcode(e,t,r,a,s,n,o,i,d){return this._loadModule().then((e=>{const t=e.module,[,r]=this._prepareTranscoding(a,s,n,d,4);return 0===t.decode(a,s)?r.slice():null}))}}f.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/uastc_rgba8_unorm_v2.wasm",f.Name="UniversalTranscoder_UASTC_RGBA_UNORM";class p extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.RGBA32&&s}getName(){return p.Name}initialize(){super.initialize(),this._transcodeInPlace=!1,this.setModulePath(p.WasmModuleURL)}transcode(e,t,r,a,s,n,o,i,d){return this._loadModule().then((e=>{const t=e.module,[,r]=this._prepareTranscoding(a,s,n,d,4);return 0===t.decode(a,s)?r.slice():null}))}}p.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/uastc_rgba8_srgb_v2.wasm",p.Name="UniversalTranscoder_UASTC_RGBA_SRGB";class T extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.R8}getName(){return T.Name}initialize(){super.initialize(),this._transcodeInPlace=!1,this.setModulePath(T.WasmModuleURL)}transcode(e,t,r,a,s,n,o,i,d){return this._loadModule().then((e=>{const t=e.module,[,r]=this._prepareTranscoding(a,s,n,d,1);return 0===t.decode(a,s)?r.slice():null}))}}T.WasmModuleURL="https://preview.babylonjs.com/1/uastc_r8_unorm.wasm",T.Name="UniversalTranscoder_UASTC_R8_UNORM";class y extends h{static CanTranscode(e,t,s){return e===r.UASTC4x4&&t===a.RG8}getName(){return y.Name}initialize(){super.initialize(),this._transcodeInPlace=!1,this.setModulePath(y.WasmModuleURL)}transcode(e,t,r,a,s,n,o,i,d){return this._loadModule().then((e=>{const t=e.module,[,r]=this._prepareTranscoding(a,s,n,d,2);return 0===t.decode(a,s)?r.slice():null}))}}y.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/uastc_rg8_unorm.wasm",y.Name="UniversalTranscoder_UASTC_RG8_UNORM";class g extends l{getName(){return g.Name}_getMSCBasisTranscoder(){return this._mscBasisTranscoderPromise||(this._mscBasisTranscoderPromise=c.LoadWASM(g.WasmModuleURL).then((e=>{if(g.UseFromWorkerThread)importScripts(g.JSModuleURL);else if("undefined"==typeof MSC_TRANSCODER)return new Promise(((t,r)=>{const a=document.getElementsByTagName("head")[0],s=document.createElement("script");s.setAttribute("type","text/javascript"),s.setAttribute("src",g.JSModuleURL),s.onload=()=>{MSC_TRANSCODER({wasmBinary:e}).then((e=>{e.initTranscoders(),this._mscBasisModule=e,t()}))},s.onerror=()=>{r("Can not load MSC_TRANSCODER script.")},a.appendChild(s)}));return new Promise((t=>{MSC_TRANSCODER({wasmBinary:e}).then((e=>{e.initTranscoders(),this._mscBasisModule=e,t()}))}))}))),this._mscBasisTranscoderPromise}static CanTranscode(e,t,r){return!0}transcode(e,t,s,n,o,i,d,c,_){return this._getMSCBasisTranscoder().then((()=>{const l=this._mscBasisModule;let h,m,u,f=null;try{h=e===r.UASTC4x4?new l.UastcImageTranscoder:new l.BasisLzEtc1sImageTranscoder;const f=e===r.UASTC4x4?l.TextureFormat.UASTC4x4:l.TextureFormat.ETC1S;m=new l.ImageInfo(f,n,o,s);const p=l.TranscodeTarget[a[t]];if(!l.isFormatSupported(p,f))throw new Error(`MSCTranscoder: Transcoding from "${r[e]}" to "${a[t]}" not supported by current transcoder build.`);if(e===r.ETC1S){const e=d.supercompressionGlobalData;h.decodePalettes(e.endpointCount,e.endpointsData,e.selectorCount,e.selectorsData),h.decodeTables(e.tablesData),m.flags=c.imageFlags,m.rgbByteOffset=0,m.rgbByteLength=c.rgbSliceByteLength,m.alphaByteOffset=c.alphaSliceByteOffset>0?c.rgbSliceByteLength:0,m.alphaByteLength=c.alphaSliceByteLength,u=h.transcodeImage(p,_,m,0,!1)}else m.flags=0,m.rgbByteOffset=0,m.rgbByteLength=i,m.alphaByteOffset=0,m.alphaByteLength=0,u=h.transcodeImage(p,_,m,0,d.hasAlpha,!1)}finally{h&&h.delete(),m&&m.delete(),u&&u.transcodedImage&&(f=u.transcodedImage.get_typed_memory_view().slice(),u.transcodedImage.delete())}return f}))}}let B,R,C;g.JSModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/msc_basis_transcoder.js",g.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/1/msc_basis_transcoder.wasm",g.UseFromWorkerThread=!0,g.Name="MSCTranscoder";const S={env:{emscripten_notify_memory_growth:function(){C=new Uint8Array(R.exports.memory.buffer)}}};class M{init(){return B||(B="undefined"!=typeof fetch?fetch(M.WasmModuleURL).then((e=>{if(e.ok)return e.arrayBuffer();throw new Error(`Could not fetch the wasm component for the Zstandard decompression lib: ${e.status} - ${e.statusText}`)})).then((e=>WebAssembly.instantiate(e,S))).then(this._init):WebAssembly.instantiateStreaming(fetch(M.WasmModuleURL),S).then(this._init),B)}_init(e){R=e.instance,S.env.emscripten_notify_memory_growth()}decode(e,t=0){if(!R)throw new Error("ZSTDDecoder: Await .init() before decoding.");const r=e.byteLength,a=R.exports.malloc(r);C.set(e,a),t=t||Number(R.exports.ZSTD_findDecompressedSize(a,r));const s=R.exports.malloc(t),n=R.exports.ZSTD_decompress(s,t,a,r),o=C.slice(s,s+n);return R.exports.free(a),R.exports.free(s),o}}M.WasmModuleURL="https://preview.babylonjs.com/zstddec.wasm";const A={ETC1S:{option:"forceRGBA",yes:{transcodeFormat:a.RGBA32,engineFormat:s.RGBA8Format,roundToMultiple4:!1},no:{cap:"etc2",yes:{alpha:!0,yes:{transcodeFormat:a.ETC2_RGBA,engineFormat:s.COMPRESSED_RGBA8_ETC2_EAC},no:{transcodeFormat:a.ETC1_RGB,engineFormat:s.COMPRESSED_RGB8_ETC2}},no:{cap:"etc1",alpha:!1,yes:{transcodeFormat:a.ETC1_RGB,engineFormat:s.COMPRESSED_RGB_ETC1_WEBGL},no:{cap:"bptc",yes:{transcodeFormat:a.BC7_RGBA,engineFormat:s.COMPRESSED_RGBA_BPTC_UNORM_EXT},no:{cap:"s3tc",yes:{alpha:!0,yes:{transcodeFormat:a.BC3_RGBA,engineFormat:s.COMPRESSED_RGBA_S3TC_DXT5_EXT},no:{transcodeFormat:a.BC1_RGB,engineFormat:s.COMPRESSED_RGB_S3TC_DXT1_EXT}},no:{cap:"pvrtc",needsPowerOfTwo:!0,yes:{alpha:!0,yes:{transcodeFormat:a.PVRTC1_4_RGBA,engineFormat:s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},no:{transcodeFormat:a.PVRTC1_4_RGB,engineFormat:s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG}},no:{transcodeFormat:a.RGBA32,engineFormat:s.RGBA8Format,roundToMultiple4:!1}}}}}}},UASTC:{option:"forceRGBA",yes:{transcodeFormat:a.RGBA32,engineFormat:s.RGBA8Format,roundToMultiple4:!1},no:{option:"forceR8",yes:{transcodeFormat:a.R8,engineFormat:s.R8Format,roundToMultiple4:!1},no:{option:"forceRG8",yes:{transcodeFormat:a.RG8,engineFormat:s.RG8Format,roundToMultiple4:!1},no:{cap:"astc",yes:{transcodeFormat:a.ASTC_4X4_RGBA,engineFormat:s.COMPRESSED_RGBA_ASTC_4X4_KHR},no:{cap:"bptc",yes:{transcodeFormat:a.BC7_RGBA,engineFormat:s.COMPRESSED_RGBA_BPTC_UNORM_EXT},no:{option:"useRGBAIfASTCBC7NotAvailableWhenUASTC",yes:{transcodeFormat:a.RGBA32,engineFormat:s.RGBA8Format,roundToMultiple4:!1},no:{cap:"etc2",yes:{alpha:!0,yes:{transcodeFormat:a.ETC2_RGBA,engineFormat:s.COMPRESSED_RGBA8_ETC2_EAC},no:{transcodeFormat:a.ETC1_RGB,engineFormat:s.COMPRESSED_RGB8_ETC2}},no:{cap:"etc1",yes:{transcodeFormat:a.ETC1_RGB,engineFormat:s.COMPRESSED_RGB_ETC1_WEBGL},no:{cap:"s3tc",yes:{alpha:!0,yes:{transcodeFormat:a.BC3_RGBA,engineFormat:s.COMPRESSED_RGBA_S3TC_DXT5_EXT},no:{transcodeFormat:a.BC1_RGB,engineFormat:s.COMPRESSED_RGB_S3TC_DXT1_EXT}},no:{cap:"pvrtc",needsPowerOfTwo:!0,yes:{alpha:!0,yes:{transcodeFormat:a.PVRTC1_4_RGBA,engineFormat:s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},no:{transcodeFormat:a.PVRTC1_4_RGB,engineFormat:s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG}},no:{transcodeFormat:a.RGBA32,engineFormat:s.RGBA8Format,roundToMultiple4:!1}}}}}}}}}}}};class U{static _IsLeafNode(e){return void 0!==e.engineFormat}get transcodeFormat(){return this._transcodeFormat}get engineFormat(){return this._engineFormat}get roundToMultiple4(){return this._roundToMultiple4}constructor(e,t,r,a,s){this._textureFormat=e,this._hasAlpha=t,this._isPowerOfTwo=r,this._caps=a,this._options=s??{},this.parseTree(A)}parseTree(e){const t=this._textureFormat===r.UASTC4x4?e.UASTC:e.ETC1S;return t&&this._parseNode(t),void 0!==t}_parseNode(e){if(e)if(U._IsLeafNode(e))this._transcodeFormat=e.transcodeFormat,this._engineFormat=e.engineFormat,this._roundToMultiple4=e.roundToMultiple4??!0;else{let t=!0;void 0!==e.cap&&(t=t&&!!this._caps[e.cap]),void 0!==e.option&&(t=t&&!!this._options[e.option]),void 0!==e.alpha&&(t=t&&this._hasAlpha===e.alpha),void 0!==e.needsPowerOfTwo&&(t=t&&this._isPowerOfTwo===e.needsPowerOfTwo),void 0!==e.transcodeFormat&&(t=Array.isArray(e.transcodeFormat)?t&&-1!==e.transcodeFormat.indexOf(this._transcodeFormat):t&&e.transcodeFormat===this._transcodeFormat),this._parseNode(t?e.yes:e.no)}}}const w=e=>0==(e&e-1)&&0!==e;class E{constructor(){this._transcoderMgr=new _}decode(e,t,r){const a={...r,...E.DefaultDecoderOptions};return Promise.resolve().then((()=>{const r=new d(e);if(!r.isValid())throw new Error("Invalid KT2 file: wrong signature");return r.parse(),r.needZSTDDecoder?(this._zstdDecoder||(this._zstdDecoder=new M),this._zstdDecoder.init().then((()=>this._decodeData(r,t,a)))):this._decodeData(r,t,a)}))}_decodeData(e,t,s){const o=e.header.pixelWidth,i=e.header.pixelHeight,d=e.textureFormat,c=new U(d,e.hasAlpha,w(o)&&w(i),t,s);s?.transcodeFormatDecisionTree&&c.parseTree(s?.transcodeFormatDecisionTree);const _=c.transcodeFormat,l=c.engineFormat,h=c.roundToMultiple4,m=this._transcoderMgr.findTranscoder(d,_,e.isInGammaSpace,s?.bypassTranscoders);if(null===m)throw new Error(`no transcoder found to transcode source texture format "${r[d]}" to format "${a[_]}"`);const u=[],f=[],p={width:0,height:0,transcodedFormat:l,mipmaps:u,isInGammaSpace:e.isInGammaSpace,hasAlpha:e.hasAlpha,transcoderName:m.getName()};let T=0;for(let t=0;t<e.header.levelCount;t++){t>0&&(T+=Math.max(e.header.layerCount,1)*e.header.faceCount*Math.max(e.header.pixelDepth>>t-1,1));const r=Math.floor(o/(1<<t))||1,a=Math.floor(i/(1<<t))||1,s=e.header.faceCount,c=(r+3>>2)*(a+3>>2)*e.dfdBlock.bytesPlane[0],l=e.levels[t].uncompressedByteLength;let y=e.data.buffer,g=e.levels[t].byteOffset+e.data.byteOffset,B=0;e.header.supercompressionScheme===n.ZStandard&&(y=this._zstdDecoder.decode(new Uint8Array(y,g,e.levels[t].byteLength),l),g=0),0===t&&(p.width=h?r+3&-4:r,p.height=h?a+3&-4:a);for(let o=0;o<s;o++){let s,i=null;e.header.supercompressionScheme===n.BasisLZ?(i=e.supercompressionGlobalData.imageDescs[T+o],s=new Uint8Array(y,g+i.rgbSliceByteOffset,i.rgbSliceByteLength+i.alphaSliceByteLength)):(s=new Uint8Array(y,g+B,c),B+=c);const h={data:null,width:r,height:a},R=m.transcode(d,_,t,r,a,l,e,i,s).then((e=>(h.data=e,e))).catch((e=>(p.errors=p.errors??"",p.errors+=e+"\n"+e.stack+"\n",null)));f.push(R),u.push(h)}}return Promise.all(f).then((()=>p))}}E.DefaultDecoderOptions={},_.RegisterTranscoder(m),_.RegisterTranscoder(u),_.RegisterTranscoder(f),_.RegisterTranscoder(p),_.RegisterTranscoder(T),_.RegisterTranscoder(y),_.RegisterTranscoder(g);const b=void 0!==e.g?e.g:"undefined"!=typeof window?window:void 0;void 0!==b&&(b.KTX2DECODER=E);const G=o;return t.default})()));
//# sourceMappingURL=babylon.ktx2Decoder.js.map